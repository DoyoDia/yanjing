/**
 * ä¸»é¡µé¢ - ä¼ æ„Ÿå™¨æµ‹è¯•ä¸è°ƒè¯•ç•Œé¢
 * ç”¨äºéªŒè¯ SensorManager æ¨¡å—çš„åŠŸèƒ½
 */

import { SensorManager, SensorDataListener, DeviceHoldMode, getSensorManager } from '../sensor/SensorManager';
import { Quaternion, Matrix4, radToDeg } from '../utils/MathUtils';
import { SensorListenerImpl } from '../utils/ListenerImplementations';
import { router } from '@kit.ArkUI';

/**
 * æ¬§æ‹‰è§’æ¥å£
 */
interface EulerAngles {
  pitch: number;
  yaw: number;
  roll: number;
}

@Entry
@Component
struct Index {
  // ä¼ æ„Ÿå™¨ç®¡ç†å™¨å®ä¾‹
  private sensorManager: SensorManager = getSensorManager();

  // æ˜¾ç¤ºçŠ¶æ€
  @State isRunning: boolean = false;
  @State holdMode: string = 'LANDSCAPE_TELESCOPE';

  // å››å…ƒæ•°æ•°æ®æ˜¾ç¤º
  @State quatX: string = '0.000';
  @State quatY: string = '0.000';
  @State quatZ: string = '0.000';
  @State quatW: string = '1.000';

  // æ¬§æ‹‰è§’ä¼°ç®—ï¼ˆä»…ç”¨äºè°ƒè¯•æ˜¾ç¤ºï¼‰
  @State pitch: string = '0.0Â°';
  @State yaw: string = '0.0Â°';
  @State roll: string = '0.0Â°';

  // è§†å›¾çŸ©é˜µæ˜¾ç¤ºï¼ˆå‰4ä¸ªå…ƒç´ ä½œä¸ºç¤ºä¾‹ï¼‰
  @State matrixPreview: string = '[1, 0, 0, 0, ...]';

  // ä¼ æ„Ÿå™¨æ•°æ®ç›‘å¬å™¨
  private sensorListener: SensorListenerImpl | null = null;

  /**
   * ä»å››å…ƒæ•°æå–æ¬§æ‹‰è§’ï¼ˆZYXé¡ºåºï¼‰
   * ä»…ç”¨äºè°ƒè¯•æ˜¾ç¤ºï¼Œä¸ç”¨äºå®é™…æ¸²æŸ“
   */
  private quaternionToEuler(q: Quaternion): EulerAngles {
    const x = q.x, y = q.y, z = q.z, w = q.w;

    // Roll (Xè½´æ—‹è½¬)
    const sinr_cosp = 2 * (w * x + y * z);
    const cosr_cosp = 1 - 2 * (x * x + y * y);
    const rollAngle = Math.atan2(sinr_cosp, cosr_cosp);

    // Pitch (Yè½´æ—‹è½¬)
    const sinp = 2 * (w * y - z * x);
    let pitchAngle: number;
    if (Math.abs(sinp) >= 1) {
      pitchAngle = Math.sign(sinp) * Math.PI / 2;
    } else {
      pitchAngle = Math.asin(sinp);
    }

    // Yaw (Zè½´æ—‹è½¬)
    const siny_cosp = 2 * (w * z + x * y);
    const cosy_cosp = 1 - 2 * (y * y + z * z);
    const yawAngle = Math.atan2(siny_cosp, cosy_cosp);

    const result: EulerAngles = { pitch: pitchAngle, yaw: yawAngle, roll: rollAngle };
    return result;
  }

  /**
   * é¡µé¢å³å°†å‡ºç°æ—¶çš„å›è°ƒ
   */
  aboutToAppear(): void {
    // åˆ›å»ºä¼ æ„Ÿå™¨ç›‘å¬å™¨
    this.sensorListener = new SensorListenerImpl((quaternion: Quaternion, viewMatrix: Matrix4) => {
      // æ›´æ–°å››å…ƒæ•°æ˜¾ç¤º
      this.quatX = quaternion.x.toFixed(3);
      this.quatY = quaternion.y.toFixed(3);
      this.quatZ = quaternion.z.toFixed(3);
      this.quatW = quaternion.w.toFixed(3);

      // ä»å››å…ƒæ•°ä¼°ç®—æ¬§æ‹‰è§’ï¼ˆä»…ç”¨äºå¯è§†åŒ–ï¼‰
      const euler = this.quaternionToEuler(quaternion);
      this.pitch = radToDeg(euler.pitch).toFixed(1) + 'Â°';
      this.yaw = radToDeg(euler.yaw).toFixed(1) + 'Â°';
      this.roll = radToDeg(euler.roll).toFixed(1) + 'Â°';

      // æ˜¾ç¤ºè§†å›¾çŸ©é˜µé¢„è§ˆ
      const m = viewMatrix.elements;
      this.matrixPreview = `[${m[0].toFixed(2)}, ${m[1].toFixed(2)}, ${m[2].toFixed(2)}, ${m[3].toFixed(2)}, ...]`;
    });

    // æ·»åŠ ä¼ æ„Ÿå™¨ç›‘å¬å™¨
    this.sensorManager.addListener(this.sensorListener);
  }

  /**
   * é¡µé¢å³å°†æ¶ˆå¤±æ—¶çš„å›è°ƒ
   */
  aboutToDisappear(): void {
    // åœæ­¢ä¼ æ„Ÿå™¨å¹¶ç§»é™¤ç›‘å¬å™¨
    this.sensorManager.stop();
    if (this.sensorListener) {
      this.sensorManager.removeListener(this.sensorListener);
    }
  }

  /**
   * åˆ‡æ¢ä¼ æ„Ÿå™¨è¿è¡ŒçŠ¶æ€
   */
  private toggleSensor(): void {
    if (this.isRunning) {
      this.sensorManager.stop();
    } else {
      this.sensorManager.start();
    }
    this.isRunning = !this.isRunning;
  }

  /**
   * åˆ‡æ¢æŒæ¡æ¨¡å¼
   */
  private cycleHoldMode(): void {
    const modes: DeviceHoldMode[] = [
      DeviceHoldMode.LANDSCAPE_TELESCOPE,
      DeviceHoldMode.PORTRAIT,
      DeviceHoldMode.FLAT
    ];
    const modeNames: string[] = ['LANDSCAPE_TELESCOPE', 'PORTRAIT', 'FLAT'];

    const currentIndex = modes.indexOf(this.sensorManager.getHoldMode());
    const nextIndex = (currentIndex + 1) % modes.length;

    this.sensorManager.setHoldMode(modes[nextIndex]);
    this.holdMode = modeNames[nextIndex];
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Text('360Â° VR Sensor Test')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 40, bottom: 20 })
        .fontColor('#FFFFFF')

      // çŠ¶æ€å¡ç‰‡
      Column() {
        // è¿è¡ŒçŠ¶æ€
        Row() {
          Circle()
            .width(12)
            .height(12)
            .fill(this.isRunning ? '#4CAF50' : '#757575')
          Text(this.isRunning ? 'ä¼ æ„Ÿå™¨è¿è¡Œä¸­' : 'ä¼ æ„Ÿå™¨å·²åœæ­¢')
            .fontSize(16)
            .fontColor(this.isRunning ? '#4CAF50' : '#757575')
            .margin({ left: 8 })
        }
        .margin({ bottom: 16 })

        // æŒæ¡æ¨¡å¼
        Text(`æŒæ¡æ¨¡å¼: ${this.holdMode}`)
          .fontSize(14)
          .fontColor('#B0BEC5')
      }
      .width('90%')
      .padding(16)
      .backgroundColor('#1E1E1E')
      .borderRadius(12)
      .margin({ bottom: 16 })

      // å››å…ƒæ•°æ•°æ®å¡ç‰‡
      Column() {
        Text('è®¾å¤‡å§¿æ€å››å…ƒæ•° (x, y, z, w)')
          .fontSize(14)
          .fontColor('#78909C')
          .margin({ bottom: 12 })

        Row() {
          this.DataItem('X', this.quatX, '#F44336')
          this.DataItem('Y', this.quatY, '#4CAF50')
          this.DataItem('Z', this.quatZ, '#2196F3')
          this.DataItem('W', this.quatW, '#FF9800')
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)
      }
      .width('90%')
      .padding(16)
      .backgroundColor('#1E1E1E')
      .borderRadius(12)
      .margin({ bottom: 16 })

      // æ¬§æ‹‰è§’æ˜¾ç¤ºå¡ç‰‡
      Column() {
        Text('ä¼°ç®—æ¬§æ‹‰è§’ (ä»…ä¾›å‚è€ƒ)')
          .fontSize(14)
          .fontColor('#78909C')
          .margin({ bottom: 12 })

        Row() {
          this.DataItem('Pitch', this.pitch, '#E91E63')
          this.DataItem('Yaw', this.yaw, '#9C27B0')
          this.DataItem('Roll', this.roll, '#00BCD4')
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceAround)
      }
      .width('90%')
      .padding(16)
      .backgroundColor('#1E1E1E')
      .borderRadius(12)
      .margin({ bottom: 16 })

      // è§†å›¾çŸ©é˜µé¢„è§ˆ
      Column() {
        Text('OpenGL è§†å›¾çŸ©é˜µé¢„è§ˆ')
          .fontSize(14)
          .fontColor('#78909C')
          .margin({ bottom: 8 })

        Text(this.matrixPreview)
          .fontSize(12)
          .fontColor('#90A4AE')
      }
      .width('90%')
      .padding(16)
      .backgroundColor('#1E1E1E')
      .borderRadius(12)
      .margin({ bottom: 24 })

      // æ§åˆ¶æŒ‰é’®
      Row() {
        Button(this.isRunning ? 'åœæ­¢' : 'å¯åŠ¨')
          .width('40%')
          .height(48)
          .fontSize(16)
          .backgroundColor(this.isRunning ? '#F44336' : '#4CAF50')
          .onClick(() => this.toggleSensor())

        Button('åˆ‡æ¢æ¨¡å¼')
          .width('40%')
          .height(48)
          .fontSize(16)
          .backgroundColor('#2196F3')
          .onClick(() => this.cycleHoldMode())
      }
      .width('90%')
      .justifyContent(FlexAlign.SpaceBetween)

      // è¿›å…¥å…¨æ™¯è§†å›¾æŒ‰é’®
      Button('ğŸŒ è¿›å…¥ 360Â° å…¨æ™¯è§†å›¾')
        .width('90%')
        .height(56)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .backgroundColor('#9C27B0')
        .margin({ top: 24 })
        .onClick(() => {
          router.pushUrl({ url: 'pages/PanoramaView' });
        })

      // ä½¿ç”¨è¯´æ˜
      Text('æ¨ªæŒæ‰‹æœºï¼Œåƒæœ›è¿œé•œä¸€æ ·è§‚å¯Ÿ')
        .fontSize(12)
        .fontColor('#546E7A')
        .margin({ top: 16 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#121212')
    .justifyContent(FlexAlign.Start)
    .alignItems(HorizontalAlign.Center)
  }

  /**
   * æ•°æ®é¡¹ç»„ä»¶æ„å»ºå™¨
   */
  @Builder
  DataItem(label: string, value: string, color: string) {
    Column() {
      Text(label)
        .fontSize(12)
        .fontColor('#78909C')
        .margin({ bottom: 4 })
      Text(value)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor(color)
    }
    .alignItems(HorizontalAlign.Center)
  }
}