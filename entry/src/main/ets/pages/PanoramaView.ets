/**
 * PanoramaView - å…¨æ™¯æ¸²æŸ“è§†å›¾é¡µé¢ï¼ˆä¸»æ§åˆ¶é¡µé¢ï¼‰
 * ä½¿ç”¨ XComponent æ‰¿è½½ OpenGL ES æ¸²æŸ“çš„ 360Â° å…¨æ™¯
 * æ”¯æŒè§†é¢‘æ’­æ”¾å’Œå¤–éƒ¨æ˜¾ç¤ºå™¨è¾“å‡º
 */

import { SensorManager, SensorDataListener, DeviceHoldMode, getSensorManager } from '../sensor/SensorManager';
import { Quaternion, Matrix4 } from '../utils/MathUtils';
import { SensorListenerImpl, ExternalDisplayListenerImpl, VideoFrameListenerImpl } from '../utils/ListenerImplementations';
import { VideoPlayerManager, VideoPlayerState, VideoFrameListener, getVideoPlayerManager } from '../video/VideoPlayerManager';
import { ExternalDisplayManager, DisplayInfo, ExternalDisplayListener, DisplayType, getExternalDisplayManager } from '../display/ExternalDisplayManager';
import { common } from '@kit.AbilityKit';
import { picker } from '@kit.CoreFileKit';
import { image } from '@kit.ImageKit';
import panoramaRenderer from 'libpanorama_renderer.so';

@Entry
@Component
struct PanoramaView {
  // XComponent æ§åˆ¶å™¨
  private xComponentController: XComponentController = new XComponentController();

  // ç®¡ç†å™¨å®ä¾‹
  private sensorManager: SensorManager = getSensorManager();
  private videoManager: VideoPlayerManager = getVideoPlayerManager();
  private displayManager: ExternalDisplayManager = getExternalDisplayManager();

  // ä¸Šä¸‹æ–‡
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext;

  // æ¸²æŸ“çŠ¶æ€
  @State isRendering: boolean = false;
  @State rendererReady: boolean = false;

  // FOV è®¾ç½®
  private readonly fovMin: number = 60;
  private readonly fovMax: number = 110;
  private readonly fovStep: number = 1;
  @State fovValue: number = 90;

  // è§¦æ§æ‹–åŠ¨è§†è§’
  private isTouching: boolean = false;
  private lastTouchX: number = 0;
  private lastTouchY: number = 0;
  private dragYaw: number = 0;   // å¼§åº¦
  private dragPitch: number = 0; // å¼§åº¦
  private readonly dragSensitivity: number = 0.003;
  private readonly maxPitch: number = Math.PI / 2 - 0.01;

  // è§†é¢‘çŠ¶æ€
  @State videoState: string = 'idle';
  @State videoProgress: number = 0;
  @State videoDuration: number = 0;
  @State videoFileName: string = 'æœªé€‰æ‹©è§†é¢‘';

  // å¤–éƒ¨æ˜¾ç¤ºå™¨çŠ¶æ€
  @State hasExternalDisplay: boolean = false;
  @State externalDisplayInfo: string = 'æœªè¿æ¥';
  @State isOutputToExternal: boolean = false;

  // æ¸²æŸ“å¾ªç¯å®šæ—¶å™¨ ID
  private renderTimerId: number = -1;

  // å¸§ç‡ç»Ÿè®¡
  @State fps: number = 0;
  private frameCount: number = 0;
  private lastFpsTime: number = 0;

  // ç›‘å¬å™¨å®ä¾‹
  private sensorListener: SensorListenerImpl | null = null;
  private displayListener: ExternalDisplayListenerImpl | null = null;
  private videoListener: VideoFrameListenerImpl | null = null;

  /**
   * é¡µé¢å³å°†å‡ºç°
   */
  aboutToAppear(): void {
    // åˆ›å»ºä¼ æ„Ÿå™¨ç›‘å¬å™¨
    this.sensorListener = new SensorListenerImpl((quaternion: Quaternion, viewMatrix: Matrix4) => {
      if (this.rendererReady) {
        const adjustedMatrix = this.applyDragToViewMatrix(viewMatrix);
        panoramaRenderer.setViewMatrix(adjustedMatrix.toFloat32Array());
      }
    });

    // åˆ›å»ºå¤–éƒ¨æ˜¾ç¤ºå™¨ç›‘å¬å™¨
    this.displayListener = new ExternalDisplayListenerImpl(
      (displayInfo: DisplayInfo) => {
        this.hasExternalDisplay = true;
        this.externalDisplayInfo = `${displayInfo.name} (${displayInfo.width}x${displayInfo.height})`;
        console.info('PanoramaView: External display connected');
      },
      (displayId: number) => {
        this.hasExternalDisplay = this.displayManager.hasExternalDisplay();
        if (!this.hasExternalDisplay) {
          this.externalDisplayInfo = 'æœªè¿æ¥';
          this.isOutputToExternal = false;
        }
        console.info('PanoramaView: External display disconnected');
      },
      (displayInfo: DisplayInfo) => {
        if (displayInfo.type === DisplayType.EXTERNAL) {
          this.externalDisplayInfo = `${displayInfo.name} (${displayInfo.width}x${displayInfo.height})`;
        }
      }
    );

    // åˆ›å»ºè§†é¢‘æ’­æ”¾ç›‘å¬å™¨
    this.videoListener = new VideoFrameListenerImpl(
      (pixelMap: image.PixelMap, width: number, height: number) => {
        // å¸§æ•°æ®å¯ç”¨æ—¶çš„å¤„ç†
      },
      (state: VideoPlayerState) => {
        this.videoState = state;
      },
      (currentTime: number, duration: number) => {
        this.videoProgress = currentTime;
        this.videoDuration = duration;
      }
    );

    // é…ç½®ä¼ æ„Ÿå™¨
    this.sensorManager.configure({
      samplingInterval: 16666667,
      holdMode: DeviceHoldMode.LANDSCAPE_TELESCOPE
    });

    // æ·»åŠ ç›‘å¬å™¨
    this.sensorManager.addListener(this.sensorListener);
    this.displayManager.addListener(this.displayListener);
    this.videoManager.addListener(this.videoListener);

    // è®¾ç½®ä¸Šä¸‹æ–‡
    this.videoManager.setContext(this.context);
    this.displayManager.setContext(this.context);

    // åˆå§‹åŒ–ç®¡ç†å™¨
    this.initializeManagers();
  }

  /**
   * é¡µé¢å³å°†æ¶ˆå¤±
   */
  aboutToDisappear(): void {
    this.stopRendering();
    this.sensorManager.stop();
    if (this.sensorListener) {
      this.sensorManager.removeListener(this.sensorListener);
    }
    if (this.displayListener) {
      this.displayManager.removeListener(this.displayListener);
    }
    if (this.videoListener) {
      this.videoManager.removeListener(this.videoListener);
    }
    this.displayManager.closeExternalWindow();
  }

  /**
   * åˆå§‹åŒ–ç®¡ç†å™¨
   */
  private async initializeManagers(): Promise<void> {
    // åˆå§‹åŒ–å¤–éƒ¨æ˜¾ç¤ºå™¨ç®¡ç†å™¨
    await this.displayManager.initialize();
    this.hasExternalDisplay = this.displayManager.hasExternalDisplay();

    if (this.hasExternalDisplay) {
      const extDisplay = this.displayManager.getFirstExternalDisplay();
      if (extDisplay) {
        this.externalDisplayInfo = `${extDisplay.name} (${extDisplay.width}x${extDisplay.height})`;
      }
    }

    // åˆå§‹åŒ–è§†é¢‘æ’­æ”¾å™¨
    await this.videoManager.initialize();
  }

  /**
   * å¼€å§‹æ¸²æŸ“å¾ªç¯
   */
  private startRendering(): void {
    if (this.isRendering) return;

    this.isRendering = true;
    this.sensorManager.start();
    this.lastFpsTime = Date.now();
    this.frameCount = 0;

    // ä½¿ç”¨ setInterval æ›¿ä»£ requestAnimationFrameï¼ˆçº¦60fpsï¼‰
    this.renderTimerId = setInterval(() => {
      if (!this.isRendering || !this.rendererReady) return;

      panoramaRenderer.render();

      this.frameCount++;
      const now = Date.now();
      if (now - this.lastFpsTime >= 1000) {
        this.fps = this.frameCount;
        this.frameCount = 0;
        this.lastFpsTime = now;
      }
    }, 16);
  }

  /**
   * åœæ­¢æ¸²æŸ“å¾ªç¯
   */
  private stopRendering(): void {
    this.isRendering = false;
    if (this.renderTimerId !== -1) {
      clearInterval(this.renderTimerId);
      this.renderTimerId = -1;
    }
    this.sensorManager.stop();
  }

  /**
   * é€‰æ‹©è§†é¢‘æ–‡ä»¶
   */
  private async selectVideo(): Promise<void> {
    try {
      const documentViewPicker = new picker.DocumentViewPicker(this.context);
      const uris = await documentViewPicker.select({
        maxSelectNumber: 1,
        selectMode: picker.DocumentSelectMode.FILE,
        fileSuffixFilters: ['.mp4', '.mov', '.webm', '.avi']
      });

      if (uris.length > 0) {
        const videoUri = uris[0];
        const parts = videoUri.split('/');
        this.videoFileName = parts[parts.length - 1] || 'è§†é¢‘æ–‡ä»¶';

        await this.videoManager.setSource(videoUri);
        console.info('PanoramaView: Video selected', videoUri);
      }
    } catch (error) {
      console.error('PanoramaView: Failed to select video', JSON.stringify(error));
    }
  }

  /**
   * æ’­æ”¾/æš‚åœè§†é¢‘
   */
  private async toggleVideoPlayback(): Promise<void> {
    const state = this.videoManager.getState();
    if (state === VideoPlayerState.PLAYING) {
      await this.videoManager.pause();
    } else {
      await this.videoManager.play();
    }
  }

  /**
   * åˆ‡æ¢å¤–éƒ¨æ˜¾ç¤ºå™¨è¾“å‡º
   */
  private async toggleExternalOutput(): Promise<void> {
    if (!this.hasExternalDisplay) {
      console.warn('PanoramaView: No external display available');
      return;
    }

    if (this.isOutputToExternal) {
      await this.displayManager.closeExternalWindow();
      this.isOutputToExternal = false;
    } else {
      const extDisplay = this.displayManager.getFirstExternalDisplay();
      if (extDisplay) {
        const windowResult = await this.displayManager.createWindowOnExternalDisplay(
          extDisplay.id,
          'pages/ExternalPanoramaView'
        );
        this.isOutputToExternal = windowResult !== null;
      }
    }
  }

  /**
   * XComponent åŠ è½½å®Œæˆå›è°ƒ
   */
  private onXComponentLoad(): void {
    console.info('PanoramaView: XComponent loaded');

    setTimeout(async () => {
      if (panoramaRenderer.isInitialized()) {
        this.rendererReady = true;
        panoramaRenderer.setStereoMode(false);
        this.applyFov();
        
        // è·å– SurfaceId å¹¶è®¾ç½®ç»™è§†é¢‘æ’­æ”¾å™¨
        const surfaceId = panoramaRenderer.getSurfaceId();
        if (surfaceId && surfaceId.length > 0) {
          await this.videoManager.setSurfaceId(surfaceId);
          console.info(`PanoramaView: SurfaceId bound to player: ${surfaceId}`);
        } else {
          console.error('PanoramaView: Failed to get SurfaceId from renderer');
        }

        console.info('PanoramaView: Renderer ready');
      } else {
        console.error('PanoramaView: Renderer failed to initialize');
      }
    }, 100);
  }

  /**
   * XComponent é”€æ¯å›è°ƒ
   */
  private onXComponentDestroy(): void {
    console.info('PanoramaView: XComponent destroyed');
    this.rendererReady = false;
    this.stopRendering();
  }

  /**
   * åº”ç”¨å½“å‰ FOV
   */
  private applyFov(): void {
    const fov = this.fovValue;
    if (this.rendererReady) {
      panoramaRenderer.setFOV(fov);
    }
  }

  /**
   * å°†è§¦æ§æ‹–åŠ¨å åŠ åˆ°ä¼ æ„Ÿå™¨è§†å›¾çŸ©é˜µ
   */
  private applyDragToViewMatrix(viewMatrix: Matrix4): Matrix4 {
    if (this.dragYaw === 0 && this.dragPitch === 0) {
      return viewMatrix;
    }

    const dragQuaternion = new Quaternion().setFromEulerZYX(this.dragYaw, this.dragPitch, 0);
    dragQuaternion.conjugate();

    const dragMatrix = new Matrix4().setFromQuaternion(dragQuaternion);
    return new Matrix4().multiplyMatrices(dragMatrix, viewMatrix);
  }

  /**
   * è§¦æ§æ‹–åŠ¨å¤„ç†
   */
  private handleTouch(event: TouchEvent): void {
    if (event.touches.length === 0) {
      return;
    }

    const touch = event.touches[0];

    if (event.type === TouchType.Down) {
      this.isTouching = true;
      this.lastTouchX = touch.x;
      this.lastTouchY = touch.y;
      return;
    }

    if (event.type === TouchType.Move && this.isTouching) {
      const dx = touch.x - this.lastTouchX;
      const dy = touch.y - this.lastTouchY;
      this.lastTouchX = touch.x;
      this.lastTouchY = touch.y;

      this.dragYaw += dx * this.dragSensitivity;
      this.dragPitch += dy * this.dragSensitivity;

      if (this.dragPitch > this.maxPitch) {
        this.dragPitch = this.maxPitch;
      } else if (this.dragPitch < -this.maxPitch) {
        this.dragPitch = -this.maxPitch;
      }
      return;
    }

    if (event.type === TouchType.Up || event.type === TouchType.Cancel) {
      this.isTouching = false;
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
   */
  private formatTime(ms: number): string {
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }

  build() {
    Stack() {
      // å…¨æ™¯æ¸²æŸ“è§†å›¾
      XComponent({
        id: 'panoramaXComponent',
        type: XComponentType.SURFACE,
        libraryname: 'panorama_renderer',
        controller: this.xComponentController
      })
        .onLoad(() => this.onXComponentLoad())
        .onDestroy(() => this.onXComponentDestroy())
        .onTouch((event: TouchEvent) => this.handleTouch(event))
        .width('100%')
        .height('100%')

      // æ§åˆ¶é¢æ¿
      Column() {
        // é¡¶éƒ¨çŠ¶æ€æ 
        Row() {
          // æ¸²æŸ“çŠ¶æ€
          Row() {
            Circle()
              .width(10)
              .height(10)
              .fill(this.isRendering ? '#4CAF50' : '#757575')
            Text(this.isRendering ? 'LIVE' : 'PAUSED')
              .fontSize(12)
              .fontColor('#FFFFFF')
              .margin({ left: 6 })
          }
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor('rgba(0, 0, 0, 0.6)')
          .borderRadius(16)

          Blank()

          // å¤–éƒ¨æ˜¾ç¤ºå™¨çŠ¶æ€
          Row() {
            Text(this.hasExternalDisplay ? 'ğŸ¥½' : 'ğŸ“±')
              .fontSize(14)
            Text(this.hasExternalDisplay ? 'çœ¼é•œå·²è¿æ¥' : 'æœªè¿æ¥çœ¼é•œ')
              .fontSize(12)
              .fontColor(this.hasExternalDisplay ? '#4CAF50' : '#757575')
              .margin({ left: 4 })
          }
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .backgroundColor('rgba(0, 0, 0, 0.6)')
          .borderRadius(16)

          Blank()

          // FPS
          Text(`${this.fps} FPS`)
            .fontSize(12)
            .fontColor('#FFFFFF')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .backgroundColor('rgba(0, 0, 0, 0.6)')
            .borderRadius(16)
        }
        .width('100%')
        .padding(12)

        Blank()

        // åº•éƒ¨æ§åˆ¶é¢æ¿
        Column() {
          // è§†é¢‘ä¿¡æ¯æ 
          Row() {
            Text(`ğŸ“¹ ${this.videoFileName}`)
              .fontSize(12)
              .fontColor('#B0BEC5')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)

            Text(`${this.formatTime(this.videoProgress)} / ${this.formatTime(this.videoDuration)}`)
              .fontSize(12)
              .fontColor('#78909C')
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })

          // è§†é¢‘è¿›åº¦æ¡
          if (this.videoDuration > 0) {
            Progress({
              value: this.videoProgress,
              total: this.videoDuration,
              type: ProgressType.Linear
            })
              .width('90%')
              .height(4)
              .color('#2196F3')
              .margin({ bottom: 12 })
          }

          // æ§åˆ¶æŒ‰é’®ç¬¬ä¸€è¡Œï¼ˆè§†é¢‘æ§åˆ¶ï¼‰
          Row() {
            Button('ğŸ“‚ é€‰æ‹©è§†é¢‘')
              .fontSize(13)
              .height(40)
              .layoutWeight(1)
              .backgroundColor('rgba(33, 150, 243, 0.8)')
              .margin({ right: 8 })
              .onClick(() => this.selectVideo())

            Button(this.videoState === VideoPlayerState.PLAYING ? 'â¸ æš‚åœ' : 'â–¶ æ’­æ”¾')
              .fontSize(13)
              .height(40)
              .layoutWeight(1)
              .backgroundColor(this.videoState === VideoPlayerState.PLAYING ?
                'rgba(255, 152, 0, 0.8)' : 'rgba(76, 175, 80, 0.8)')
              .onClick(() => this.toggleVideoPlayback())
          }
          .width('90%')
          .margin({ bottom: 8 })

          // æ§åˆ¶æŒ‰é’®ç¬¬äºŒè¡Œï¼ˆæ¸²æŸ“æ§åˆ¶ï¼‰
          Row() {
            Button(this.isRendering ? 'â¹ åœæ­¢æ¸²æŸ“' : 'â–¶ å¼€å§‹æ¸²æŸ“')
              .fontSize(13)
              .height(40)
              .layoutWeight(1)
              .backgroundColor(this.isRendering ?
                'rgba(244, 67, 54, 0.8)' : 'rgba(76, 175, 80, 0.8)')
              .onClick(() => {
                if (this.isRendering) {
                  this.stopRendering();
                } else {
                  this.startRendering();
                }
              })
          }
          .width('90%')
          .margin({ bottom: 8 })

          // FOV æ»‘å—
          Column() {
            Text(`ğŸ”­ FOV ${this.fovValue}Â°`)
              .fontSize(12)
              .fontColor('#B0BEC5')
              .margin({ bottom: 6 })

            Slider({
              value: this.fovValue,
              min: this.fovMin,
              max: this.fovMax,
              step: this.fovStep
            })
              .width('90%')
              .onChange((value: number) => {
                this.fovValue = Math.round(value);
                this.applyFov();
              })
          }
          .width('90%')
          .margin({ bottom: 8 })

          // æ§åˆ¶æŒ‰é’®ç¬¬ä¸‰è¡Œï¼ˆå¤–éƒ¨æ˜¾ç¤ºå™¨ï¼‰
          if (this.hasExternalDisplay) {
            Button(this.isOutputToExternal ? 'ğŸ”´ åœæ­¢çœ¼é•œè¾“å‡º' : 'ğŸ¥½ è¾“å‡ºåˆ°çœ¼é•œ')
              .fontSize(13)
              .height(40)
              .width('90%')
              .backgroundColor(this.isOutputToExternal ?
                'rgba(244, 67, 54, 0.8)' : 'rgba(0, 150, 136, 0.8)')
              .margin({ bottom: 8 })
              .onClick(() => this.toggleExternalOutput())
          }

          // å¤–éƒ¨æ˜¾ç¤ºå™¨ä¿¡æ¯
          Text(`å¤–éƒ¨æ˜¾ç¤ºå™¨: ${this.externalDisplayInfo}`)
            .fontSize(11)
            .fontColor('#546E7A')
            .margin({ bottom: 16 })
        }
        .width('100%')
        .padding({ bottom: 16 })
        .backgroundColor('rgba(0, 0, 0, 0.7)')
        .borderRadius({ topLeft: 20, topRight: 20 })
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
  }
}
